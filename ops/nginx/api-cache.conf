proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=apicache:50m max_size=1g inactive=12h use_temp_path=off;
proxy_cache_lock on;
proxy_cache_lock_timeout 20s;
proxy_cache_min_uses 1;
proxy_cache_background_update on;

map $http_authorization $no_cache_auth {
  default         1;
  ""              0;
}

# Cache only idempotent data APIs; exclude auth/user-specific routes
location ~ ^/api/v1/(redox_analysis|water_quality|site_comparison|correlation|trends|statistics)(/|$) {
  proxy_pass http://127.0.0.1:5000;
  proxy_set_header Host $host;
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  # Timeouts appropriate for heavy queries
  proxy_read_timeout 300s;
  proxy_connect_timeout 15s;
  proxy_send_timeout 60s;

  # Enable response cache
  proxy_cache apicache;
  proxy_cache_key "$scheme$host$request_uri";
  proxy_cache_revalidate on;               # honor ETag/Last-Modified from Flask
  proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
  proxy_cache_valid 200 304 12h;
  add_header X-Proxy-Cache $upstream_cache_status always;

  # Do not vary cache by cookies; ignore Set-Cookie for these public data endpoints
  proxy_ignore_headers Set-Cookie;

  # Bypass for authorized/personalized requests just in case
  proxy_no_cache $no_cache_auth;
  proxy_cache_bypass $no_cache_auth;
}

